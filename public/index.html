<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Chat!</title>
    <link href="https://fonts.googleapis.com/css?family=Courgette|Gloria+Hallelujah|Merienda" rel="stylesheet">
    <link rel="stylesheet" type="text/css" media="screen" href="style.css" />
    <!-- <script src="main.js"></script> -->
</head>

<body>

    <h1>Chat App!</h1>
    <div id='show-rooms'>Show all rooms</div>
    <div id='room-list'>
        <span id='drop-title'>Room List:</span>
        <br>
        <span id='the-rooms'></span>
    </div>

    <h2 id='room-name'>Room name: general</h2>
    <button id='showRoomMessages'>Get messages</button>
    <br>
    <br>
    <label for='room-dropdown'>Enter name of room to join:
        <br>
        <span id='room-require'>[Must be only lowercase letters.]</span>
    </label>
    <br>
    <input type='text' id='room-dropdown'></input>
    <button id='submit-room' onclick='submitRoom()'>Submit room</button>
    <br>
    <br>
    <label for='messageBody'>Enter message:</label>
    <div id='form-input'>
        <form id='chat-form' action='chat' method='POST'>
            <input autocomplete="off" id='messageBody' type='text' author='body'>
            <input id='submit-button' type='submit'>
        </form>
    </div>
    <div>
        <h2 id='room-messages-title'>Room messages:</h2>
        <div id='chat-log'></div>
        <div id='invalid-alert'>Room ID must be only lowercase letters.
            <br>
            <button onclick='closeAlert()' id='close-alert'>Close Alert</button>
        </div>
    </div>

    <script>

        let chatForm = document.getElementById('chat-form')
        let chatLog = document.getElementById('chat-log')
        let showMessageButton = document.getElementById('showRoomMessages')
        let roomDropdown = 'general'
        let body = document.querySelector('body')
        let roomList = document.getElementById('room-list')
        let theRooms = document.getElementById('the-rooms')

        populateRoomList()

        function closeAlert() {
            let alert = document.getElementById('invalid-alert')
            alert.style = 'display: none;'
        }

        function populateRoomList() {
            theRooms.innerHTML = ''
            fetch('/rooms', {
                method: 'GET',

            }).then(response => response.json())
                .then(rooms => {
                    // console.log(rooms)
                    theRooms.innerHTML += rooms.join('<br>');
                })
        }

        function submitRoom() {
            roomDropdown = document.getElementById('room-dropdown').value
            if (roomDropdown.includes(' ')) {
                roomDropdown = roomDropdown.split(' ').join('')
                // console.log(roomDropdown)
            }
            if (roomDropdown != '') {
                let regex = /^[a-z]+$/
                if (regex.test(roomDropdown)) {
                    document.getElementById('room-name').textContent = 'Room name: ' + roomDropdown

                    fetch(`/postRoom/${roomDropdown}`, {
                        method: 'POST',
                    }).then(response => response.json())
                        .then(messages => {
                            // console.log("post room" + messages)
                            chatLog.innerHTML = messages.map(message => message.body).join('')
                        })
                    populateRoomList()

                } else {
                    let alert = document.getElementById('invalid-alert')
                    alert.style = "display: inline-block;"
                    roomDropdown = 'general'
                }
            }
            document.getElementById('room-dropdown').value = ''
            chatLog.innerHTML = ''
            if (roomDropdown === '') {
                document.getElementById('room-name').textContent = 'Room name: all'
                body.style = 'background-color: rgb(3, 194, 3); color: white;'
            } else if (roomDropdown === 'dogs') {
                body.style = 'background-color: black; color: white;'
                chatLog.style = 'background-color: rgba(255, 255, 255, 0.5);'
            } else if (roomDropdown === 'groot') {
                body.style = 'background-image: url("images/grootExplosion.jpg"), url("images/happyGroot.jpg"); background-position: bottom right, top right; background-size: 50% 50%, 50% 50%; background-repeat:no-repeat;'
            } else if (roomDropdown === 'general') {
                body.style = 'background-color: rgb(2, 83, 2); color: white;'
            } else {
                body.style = 'background-color: rgb(2, 83, 2); color: white;'
                chatLog.style = 'background-color: rgba(0, 0, 0, 0.5);'
            }
            document.getElementById('messageBody').value = ''

        }
        chatForm.addEventListener('submit', (event) => {
            let inputElement = chatForm.querySelector('input[author=body]')
            let message = inputElement.value;
            let params = new URLSearchParams();
            params.append('body', message);
            document.getElementById('messageBody').value = ''
            console.log("input element: " + inputElement)
            console.log("message: " + message)
            console.log("params: " + params)
            
            if (roomDropdown === '' || roomDropdown === 'general') {
                chatPath = '/chat'
            } else {
                chatPath = '/chat' + "/" + roomDropdown
            }

            fetch(chatPath, {
                method: 'POST',
                body: params
            }).then(response => response.json())
                .then(messages => {
                    // console.log(messages)
                    chatLog.innerHTML = messages.map(message => "<div class='message-class'><u>By:</u> " + message.author +" <u>At:</u> "+ message.when + "<br><u>Body:</u> " + message.body + " <u>Room:</u> " + message.room + "</div>").join('')
                    populateRoomList()
                })
            event.preventDefault();
        })

        showMessageButton.addEventListener('click', (event) => {
            console.log('show messages!')
            document.getElementById('messageBody').value = ''
            if (roomDropdown === '') {
                chatPath = '/chat'
            } else {
                chatPath = '/chat' + "/" + roomDropdown
            }
            // console.log(chatPath)

            function flattenDeep(arr1) {
                return arr1.reduce((acc, val) => Array.isArray(val) ? acc.concat(flattenDeep(val)) : acc.concat(val), []);
            }

            fetch(chatPath, {
                method: 'GET',

            }).then(response => response.json())
                .then(messages => {
                    allMessagesArray = messages.map((message) => {
                        // console.log(message);
                        if (message.body) {
                            return "<div class='message-class'><u>By:</u> " + message.author +" <u>At:</u> "+ message.when + "<br><u>Body:</u> " + message.body + " <u>Room:</u> " + message.room + "</div>";
                        } else if (message.length > 0) {
                            messageArray = []
                            if (message.length > 1) {
                                for (let theMessage of message) {
                                    theMessage = "<div class='message-class'><u>By:</u> " + theMessage.author +" <u>At:</u> "+ theMessage.when + "<br><u>Body:</u> " + theMessage.body + " <u>Room:</u> " + theMessage.room + "</div>";
                                    messageArray.push(theMessage)
                                }
                            } else {
                                theMessage = "<div class='message-class'><u>By:</u> " + message[0].author + " <u>At:</u> "+message[0].when + "<br><u>Body:</u> " + message[0].body + " <u>Room:</u> " + message[0].room + "</div>";
                                messageArray.push(theMessage)
                            }
                            return messageArray

                        }
                    })
                    allMessagesArray = allMessagesArray.filter(function (element) {
                        return element !== undefined;
                    });
                    chatLog.innerHTML = flattenDeep(allMessagesArray).join('')
                })

        })

    </script>
</body>

</html>